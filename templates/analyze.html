<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze Transaction</title>
    <meta name="description" content="Analyze a transaction for fraud risk">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">
            <span class="nav-title"></span>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/analyze" class="nav-link active">Analyze</a>
            <a href="/model" class="nav-link">Model</a>
            <a href="/audit" class="nav-link">Audit Log</a>

        </div>
        <div class="nav-status">

            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">

                <svg class="sun-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                        clip-rule="evenodd" />
                </svg>
                <svg class="moon-icon" viewBox="0 0 20 20" fill="currentColor" style="display:none;">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                </svg>
            </button>
            <!-- Footer Removed -->
        </div>
    </nav>

    <!-- Model Panel Removed -->



    <!-- Main Content -->
    <main class="main">
        <div class="analyze-container">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <h1 class="header-title">Transaction Analysis</h1>
                    <p class="header-subtitle">Enter transaction details to get instant fraud risk assessment</p>
                </div>
            </header>

            <!-- Analysis Form -->
            <form class="analyze-form" id="analyzeForm" onsubmit="analyzeTransaction(event)">
                <!-- Basic Info Section -->
                <div class="form-section">
                    <h3 class="form-section-title">Transaction Details</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="amount">Amount ($)</label>
                            <input type="number" id="amount" name="amount" class="form-input" placeholder="0.00"
                                step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="time">Time (seconds)</label>
                            <input type="number" id="time" name="time" class="form-input" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="customerId">Customer ID</label>
                            <input type="text" id="customerId" name="customerId" class="form-input"
                                placeholder="CUS_12345">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="merchantId">Merchant ID</label>
                            <input type="text" id="merchantId" name="merchantId" class="form-input"
                                placeholder="MER_1234">
                        </div>
                    </div>
                </div>

                <!-- V Features Section -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        PCA Features (V1-V28)
                        <span
                            style="font-weight: 400; font-size: 0.75rem; color: var(--color-text-tertiary); margin-left: 0.5rem;">From
                            credit card dataset</span>
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="v1">V1</label>
                            <input type="number" id="v1" name="v1" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v2">V2</label>
                            <input type="number" id="v2" name="v2" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v3">V3</label>
                            <input type="number" id="v3" name="v3" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v4">V4</label>
                            <input type="number" id="v4" name="v4" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v5">V5</label>
                            <input type="number" id="v5" name="v5" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v6">V6</label>
                            <input type="number" id="v6" name="v6" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v7">V7</label>
                            <input type="number" id="v7" name="v7" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v8">V8</label>
                            <input type="number" id="v8" name="v8" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v9">V9</label>
                            <input type="number" id="v9" name="v9" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v10">V10</label>
                            <input type="number" id="v10" name="v10" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v11">V11</label>
                            <input type="number" id="v11" name="v11" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v12">V12</label>
                            <input type="number" id="v12" name="v12" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v13">V13</label>
                            <input type="number" id="v13" name="v13" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v14">V14</label>
                            <input type="number" id="v14" name="v14" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v15">V15</label>
                            <input type="number" id="v15" name="v15" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v16">V16</label>
                            <input type="number" id="v16" name="v16" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v17">V17</label>
                            <input type="number" id="v17" name="v17" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v18">V18</label>
                            <input type="number" id="v18" name="v18" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v19">V19</label>
                            <input type="number" id="v19" name="v19" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v20">V20</label>
                            <input type="number" id="v20" name="v20" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v21">V21</label>
                            <input type="number" id="v21" name="v21" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v22">V22</label>
                            <input type="number" id="v22" name="v22" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v23">V23</label>
                            <input type="number" id="v23" name="v23" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v24">V24</label>
                            <input type="number" id="v24" name="v24" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v25">V25</label>
                            <input type="number" id="v25" name="v25" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v26">V26</label>
                            <input type="number" id="v26" name="v26" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v27">V27</label>
                            <input type="number" id="v27" name="v27" class="form-input" placeholder="0.0" step="any">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="v28">V28</label>
                            <input type="number" id="v28" name="v28" class="form-input" placeholder="0.0" step="any">
                        </div>
                    </div>
                </div>

                <!-- Quick Fill -->
                <div class="form-section">
                    <h3 class="form-section-title">Quick Fill Test Data</h3>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secondary" onclick="fillTestData('legitimate')">
                            Legitimate Transaction
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="fillTestData('suspicious')">
                            Suspicious Transaction
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="fillTestData('fraud')">
                            High-Risk Fraud
                        </button>
                    </div>
                </div>

                <!-- Submit Button -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
                    <button type="button" class="btn btn-train" onclick="startTraining()">
                        <svg viewBox="0 0 20 20" fill="currentColor" style="width: 16px; height: 16px;">
                            <path fill-rule="evenodd"
                                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                                clip-rule="evenodd" />
                        </svg>
                        Train New Model
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Analyze Risk
                    </button>
                </div>
            </form>

            <!-- Training Panel (Hidden by default) -->
            <div class="training-panel hidden" id="trainingPanel">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <svg viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                                    clip-rule="evenodd" />
                            </svg>
                            Model Training
                        </div>
                        <div class="header-actions" style="display: flex; align-items: center; gap: 12px;">
                            <div class="training-status" id="trainingStatus">Idle</div>
                            <button id="btnCancelTraining" class="btn btn-cancel hidden" onclick="cancelTraining()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <path d="M18 6L6 18M6 6l12 12"></path>
                                </svg>
                                Cancel
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Progress Bar -->
                        <div class="training-progress">
                            <div class="progress-header">
                                <span>Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Metrics Grid -->
                        <div class="training-metrics" id="trainingMetrics">
                            <div class="metric-card">
                                <div class="metric-value" id="metricAuc">--</div>
                                <div class="metric-label">AUC-ROC</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metricPrAuc">--</div>
                                <div class="metric-label">PR-AUC</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metricLoss">--</div>
                                <div class="metric-label">Loss</div>
                            </div>

                            <div class="metric-card">
                                <div class="metric-value" id="metricEpoch">--</div>
                                <div class="metric-label">Epoch</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metricTrees">--</div>
                                <div class="metric-label">Trees</div>
                            </div>

                            <div class="chart-container"
                                style="grid-column: 1 / -1; position: relative; height: 300px; width: 100%;">
                                <canvas id="lossChart"></canvas>
                            </div>
                        </div>

                        <!-- Feature Importance -->
                        <div class="feature-importance" id="featureImportance">
                            <h4 class="section-title">Feature Importance</h4>
                            <div class="importance-bars" id="importanceBars">
                                <!-- Filled by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Panel (Hidden by default) -->
            <div class="result-panel hidden" id="resultPanel">
                <div class="result-card" id="resultCard">
                    <div class="result-header" id="resultHeader">
                        <div style="flex: 1;">
                            <div class="result-title" id="resultTitle">Risk Assessment</div>
                            <div style="font-size: 1rem; color: var(--color-text-secondary); margin-top: 12px;"
                                id="resultTimestamp"></div>
                        </div>
                        <div class="result-probability" id="resultProbability">--</div>
                    </div>
                    <div class="result-body">
                        <!-- Recommendation -->
                        <div class="result-section">
                            <div class="result-section-title">Recommendation</div>
                            <div class="result-recommendation" id="resultRecommendation">--</div>
                        </div>

                        <!-- Temporal Context -->
                        <div class="result-section">
                            <div class="result-section-title">Temporal Context</div>
                            <div class="context-grid" id="contextGrid">
                                <!-- Filled by JS -->
                            </div>
                        </div>

                        <!-- Risk Factors -->
                        <div class="result-section">
                            <div class="result-section-title">Primary Risk Factors</div>
                            <div class="factors-list" id="factorsList">
                                <!-- Filled by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Removed -->

    <script>
        // Test data presets
        const testData = {
            legitimate: {
                amount: 49.99, time: 36000,
                v1: -1.359807, v2: -0.072781, v3: 2.536347, v4: 1.378155, v5: -0.338321,
                v6: 0.462388, v7: 0.239599, v8: 0.098698, v9: 0.363787, v10: 0.090794,
                v11: -0.551600, v12: -0.617801, v13: -0.991390, v14: -0.311169, v15: 1.468177,
                v16: -0.470401, v17: 0.207971, v18: 0.025791, v19: 0.403993, v20: 0.251412,
                v21: -0.018307, v22: 0.277838, v23: -0.110474, v24: 0.066928, v25: 0.128539,
                v26: -0.189115, v27: 0.133558, v28: -0.021053
            },
            suspicious: {
                amount: 1250.00, time: 14400,
                v1: -2.312227, v2: 1.951992, v3: -1.609851, v4: 3.997906, v5: -0.522188,
                v6: -1.426545, v7: -2.537387, v8: 1.391657, v9: -2.770089, v10: -2.772272,
                v11: 3.202033, v12: -2.899907, v13: -0.595222, v14: -4.289254, v15: 0.389724,
                v16: -1.140747, v17: -2.830056, v18: -0.016850, v19: 0.416956, v20: 0.126911,
                v21: 0.517232, v22: -0.035049, v23: -0.465211, v24: 0.320198, v25: 0.044519,
                v26: 0.177840, v27: 0.261145, v28: -0.143276
            },
            fraud: {
                amount: 9999.00, time: 13620,
                v1: -18.5, v2: 8.234567, v3: -15.123456, v4: 12.345678, v5: -8.765432,
                v6: -5.432109, v7: -12.345678, v8: 15.234567, v9: -6.543210, v10: -18.234567,
                v11: 10.123456, v12: -15.678901, v13: -2.345678, v14: -18.5, v15: 0.876543,
                v16: -8.765432, v17: -12.123456, v18: -3.456789, v19: 2.345678, v20: 0.987654,
                v21: 1.234567, v22: -0.654321, v23: -2.876543, v24: 0.543210, v25: 0.321098,
                v26: 0.654321, v27: 1.234567, v28: -0.876543
            }
        };

        function fillTestData(type) {
            const data = testData[type];
            if (!data) return;
            document.getElementById('amount').value = data.amount;
            document.getElementById('time').value = data.time;
            for (let i = 1; i <= 28; i++) {
                const input = document.getElementById(`v${i}`);
                if (input && data[`v${i}`] !== undefined) {
                    input.value = data[`v${i}`];
                }
            }
        }

        function clearForm() {
            document.getElementById('analyzeForm').reset();
            document.getElementById('resultPanel').classList.add('hidden');
        }

        async function analyzeTransaction(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px;"></span> Analyzing...';

            const formData = {
                amount: parseFloat(document.getElementById('amount').value) || 0,
                time: parseInt(document.getElementById('time').value) || 0
            };

            for (let i = 1; i <= 28; i++) {
                const value = document.getElementById(`v${i}`).value;
                formData[`v${i}`] = parseFloat(value) || 0;
            }

            try {
                const response = await fetch('/api/analyze-risk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Analysis failed');
                }

                const result = await response.json();

                // Display the result
                displayResult(result);

                // Note: Transaction appending happens automatically in the backend

            } catch (error) {
                console.error('Analysis failed:', error);
                alert('Analysis failed: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Analyze Risk';
            }
        }

        function displayResult(result) {
            const panel = document.getElementById('resultPanel');
            const header = document.getElementById('resultHeader');
            const probability = document.getElementById('resultProbability');
            const title = document.getElementById('resultTitle');
            const timestamp = document.getElementById('resultTimestamp');
            const recommendation = document.getElementById('resultRecommendation');
            const contextGrid = document.getElementById('contextGrid');
            const factorsList = document.getElementById('factorsList');

            const riskClass = result.risk_level.toLowerCase();
            header.className = `result-header ${riskClass}-risk`;
            probability.className = `result-probability ${riskClass}`;

            probability.textContent = `${(result.fraud_probability * 100).toFixed(1)}%`;
            title.textContent = `${result.risk_level} Risk Assessment`;
            timestamp.textContent = `Analyzed at ${new Date().toLocaleTimeString()}`;
            recommendation.textContent = result.recommendation;

            const ctx = result.temporal_context;
            contextGrid.innerHTML = `
                <div class="context-item">
                    <span class="context-label">Recent Fraud Count</span>
                    <span class="context-value">${ctx.recent_fraud_count}</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Time Since Last Fraud</span>
                    <span class="context-value">${Math.floor(ctx.time_since_last_fraud / 60)}m ${ctx.time_since_last_fraud % 60}s</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Fraud Contagion Score</span>
                    <span class="context-value">${ctx.fraud_contagion_score.toFixed(2)}</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Transaction Intensity</span>
                    <span class="context-value">${ctx.transaction_intensity_ratio.toFixed(1)}x normal</span>
                </div>
            `;

            // Display primary risk factors
            if (result.explanation && result.explanation.primary_factors) {
                factorsList.innerHTML = result.explanation.primary_factors.map(factor => `
                    <div class="factor-item">
                        <span>${factor}</span>
                    </div>
                `).join('');
            } else {
                factorsList.innerHTML = '<div class="factor-item"><span>No specific risk factors identified</span></div>';
            }

            // Show the result panel
            panel.classList.remove('hidden');

            // Scroll to result panel smoothly
            setTimeout(() => {
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcons(newTheme);
        }

        function updateThemeIcons(theme) {
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            if (theme === 'dark') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcons(savedTheme);
        })();

        // Training functionality
        let socket;
        let lossChart;

        function initSocket() {
            if (socket) return;

            socket = io();

            socket.on('training_started', (state) => {
                const trainingPanel = document.getElementById('trainingPanel');
                trainingPanel.classList.remove('hidden');
                document.getElementById('btnCancelTraining').classList.remove('hidden');
                updateTrainingUI(state);
                initChart();
            });


            socket.on('training_progress', (state) => {
                updateTrainingUI(state);
                if (state.loss_history && state.loss_history.length > 0) {
                    if (!lossChart) {
                        console.log('Initializing chart from progress update');
                        initChart();
                    }
                    updateChart(state.loss_history);
                }
            });


            socket.on('training_completed', (state) => {
                updateTrainingUI(state);
                renderFeatureImportance(state.feature_importance);
                document.getElementById('trainingStatus').textContent = 'Completed';
                document.getElementById('trainingStatus').className = 'training-status completed';
                document.getElementById('btnCancelTraining').classList.add('hidden');
            });

            socket.on('training_cancelled', (state) => {
                document.getElementById('trainingStatus').textContent = 'Cancelled';
                document.getElementById('trainingStatus').className = 'training-status error';
                document.getElementById('btnCancelTraining').classList.add('hidden');
            });


            socket.on('training_error', (data) => {
                alert('Training error: ' + data.error);
                document.getElementById('trainingStatus').textContent = 'Error';
                document.getElementById('trainingStatus').className = 'training-status error';
            });
        }

        function updateTrainingUI(state) {
            document.getElementById('trainingStatus').textContent = state.status.charAt(0).toUpperCase() + state.status.slice(1);
            document.getElementById('progressPercent').textContent = `${state.progress}%`;
            document.getElementById('progressFill').style.width = `${state.progress}%`;

            if (state.metrics) {
                document.getElementById('metricAuc').textContent = state.metrics.auc_roc || '--';
                document.getElementById('metricPrAuc').textContent = state.metrics.pr_auc || '--';
                document.getElementById('metricLoss').textContent = state.metrics.loss || '--';
                document.getElementById('metricEpoch').textContent = state.current_epoch || '--';
                document.getElementById('metricTrees').textContent = state.metrics.trees || '--';
            }
        }

        function initChart() {
            const ctx = document.getElementById('lossChart').getContext('2d');
            if (lossChart) lossChart.destroy();

            lossChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Loss',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'AUC-ROC',
                            data: [],
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6,
                                font: { size: 11 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'Epoch', color: '#64748b' },
                            ticks: { color: '#64748b' },
                            grid: { display: false }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Loss', color: '#ef4444' },
                            ticks: { color: '#64748b' },
                            min: 0,
                            suggestedMax: 1,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'AUC', color: '#3b82f6' },
                            ticks: { color: '#64748b' },
                            min: 0,
                            max: 1,
                            grid: { drawOnChartArea: false, color: 'rgba(0,0,0,0.05)' }
                        }
                    }

                }
            });
            console.log('Chart initialized');
        }

        function updateChart(history) {
            if (!lossChart || !history.length) return;

            // Sliding window: Show only last 50 epochs to prevent "expanding without bound"
            const windowSize = 50;
            const recentHistory = history.slice(-windowSize);

            lossChart.data.labels = recentHistory.map(h => h.epoch);
            lossChart.data.datasets[0].data = recentHistory.map(h => h.loss);
            lossChart.data.datasets[1].data = recentHistory.map(h => h.auc);

            // Ensure scales update
            lossChart.update();
        }

        function renderFeatureImportance(importance) {
            const container = document.getElementById('importanceBars');
            if (!importance) return;

            container.innerHTML = importance.map(item => `
                <div class="importance-item">
                    <div class="importance-info">
                        <span class="importance-name">${item.feature_name}</span>
                        <span class="importance-val">${(item.importance * 100).toFixed(1)}%</span>
                    </div>
                    <div class="importance-bar-bg">
                        <div class="importance-bar-fill" style="width: ${item.importance * 100}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function startTraining() {
            initSocket();
            initChart();

            const trainingPanel = document.getElementById('trainingPanel');
            document.getElementById('btnCancelTraining').classList.add('hidden');

            trainingPanel.classList.remove('hidden');
            trainingPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });

            fetch('/api/train-model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    use_additional_dataset: true,
                    epochs: 100
                })
            }).then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Training failed: ' + data.error);
                    }
                }).catch(error => {
                    console.error('Training error:', error);
                    alert('Failed to start training.');
                });
        }

        function cancelTraining() {
            if (!confirm('Are you sure you want to cancel training?')) return;

            fetch('/api/cancel-training', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Failed to cancel: ' + data.error);
                    }
                }).catch(error => {
                    console.error('Cancel error:', error);
                });
        }


    </script>
</body>

</html>